<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Carte ARG avancÃ©e</title>
<style>
body {margin:0; background:#0b0b12; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; font-family:sans-serif; color:#fff;}
.map-container {position:relative; display:inline-block; max-width:100%; max-height:100vh; overflow:auto;}
.map-container img.Map {display:block; width:100%; height:auto;}
.point {
  position:absolute;
  width:100px;
  height:100px;
  transform:translate(-50%, -50%);
  cursor:pointer;
  animation: pulse 1.5s infinite;
  filter: drop-shadow(0 0 15px #00ffcc);
}
@keyframes pulse {
  0% { transform: translate(-50%, -50%) scale(1); opacity:1; }
  50% { transform: translate(-50%, -50%) scale(1.1); opacity:0.8; }
  100% { transform: translate(-50%, -50%) scale(1); opacity:1; }
}
#admin-btn {position:fixed; top:10px; right:10px; background:#222; color:#fff; border:1px solid #555; border-radius:6px; padding:6px 10px; cursor:pointer;}
#edit-hint {position:fixed; top:50px; right:10px; background:rgba(0,0,0,0.6); padding:5px 8px; border-radius:4px; font-size:13px; display:none;}
</style>
</head>
<body>

<div class="map-container" id="map-container">
  <img src="Map.png" alt="Map" class="Map" id="Map">
</div>

<button id="admin-btn">ðŸ‘‘ Admin</button>
<div id="edit-hint">Mode Ã©dition actif â€” Clique sur la map pour ajouter un point</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const ADMIN_ID = "admin";
const ADMIN_PWD = "1234";
const POINT_IMG = "point.gif";

let editMode = false;
const adminBtn = document.getElementById("admin-btn");
const editHint = document.getElementById("edit-hint");
const mapContainer = document.getElementById("map-container");
const MapImage = document.getElementById("Map");

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "TON_API_KEY",
  authDomain: "TON_PROJET.firebaseapp.com",
  databaseURL: "https://TON_PROJET.firebaseio.com",
  projectId: "TON_PROJET",
  storageBucket: "TON_PROJET.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- CrÃ©e un point ---
function createPoint(xPercent, yPercent, contentType, content, enigmeText, codeSecret) {
  const point = document.createElement("div");
  point.className = "point";
  point.dataset.x = xPercent;
  point.dataset.y = yPercent;
  point.dataset.type = contentType;
  point.dataset.content = content;
  point.dataset.enigme = enigmeText;
  point.dataset.code = codeSecret || "";

  const img = document.createElement("img");
  img.src = POINT_IMG;
  img.alt = "Point lumineux";
  img.style.width = "100%";
  img.style.height = "100%";

  point.appendChild(img);
  mapContainer.appendChild(point);
  updatePoints();

  // --- Popup au clic ---
  point.addEventListener("click", ev => {
    ev.stopPropagation();
    const popup = document.createElement("div");
    popup.style.position = "fixed";
    popup.style.top = 0;
    popup.style.left = 0;
    popup.style.width = "100%";
    popup.style.height = "100%";
    popup.style.background = "rgba(0,0,0,0.9)";
    popup.style.display = "flex";
    popup.style.flexDirection = "column";
    popup.style.justifyContent = "center";
    popup.style.alignItems = "center";
    popup.style.zIndex = 9999;
    popup.style.padding = "20px";
    popup.style.textAlign = "center";

    const enigme = document.createElement("div");
    enigme.textContent = enigmeText || "Mini-Ã©nigme...";
    enigme.style.color = "#00ffcc";
    enigme.style.fontSize = "20px";
    enigme.style.marginBottom = "20px";
    popup.appendChild(enigme);

    if(point.dataset.code) {
      // Mini-jeu code secret
      const input = document.createElement("input");
      input.placeholder = "Entrez le code";
      input.style.padding = "8px";
      input.style.fontSize = "16px";
      input.style.marginBottom = "10px";
      const btn = document.createElement("button");
      btn.textContent = "Valider";
      btn.style.padding = "8px 12px";
      btn.style.cursor = "pointer";

      btn.addEventListener("click", () => {
        if(input.value === point.dataset.code){
          showContent(point.dataset.type, point.dataset.content, popup);
        } else {
          alert("Code incorrect !");
        }
      });

      popup.appendChild(input);
      popup.appendChild(btn);
    } else {
      // Pas de code, affiche direct le contenu
      showContent(point.dataset.type, point.dataset.content, popup);
    }

    document.body.appendChild(popup);
    popup.addEventListener("click", e => {
      if(e.target===popup) popup.remove();
    });
  });
}

// --- Affiche le contenu selon le type ---
function showContent(type, content, popup){
  if(type==="image"){
    const imgPopup = document.createElement("img");
    imgPopup.src = content;
    imgPopup.style.maxWidth = "80%";
    imgPopup.style.maxHeight = "50%";
    imgPopup.style.border = "4px solid #00ffcc";
    imgPopup.style.borderRadius = "8px";
    imgPopup.style.marginTop = "10px";
    popup.appendChild(imgPopup);
  } else if(type==="lien"){
    const a = document.createElement("a");
    a.href = content;
    a.target="_blank";
    a.textContent = content;
    a.style.color="#00ffcc";
    a.style.fontSize="18px";
    a.style.marginTop="10px";
    popup.appendChild(a);
  } else if(type==="texte"){
    const div = document.createElement("div");
    div.textContent = content;
    div.style.color="#00ffcc";
    div.style.fontSize="18px";
    div.style.marginTop="10px";
    popup.appendChild(div);
  }
}

// --- Repositionne points ---
function updatePoints() {
  const rect = MapImage.getBoundingClientRect();
  document.querySelectorAll(".point").forEach(p => {
    const x = parseFloat(p.dataset.x);
    const y = parseFloat(p.dataset.y);
    p.style.left = (x * rect.width / 100) + "px";
    p.style.top = (y * rect.height / 100) + "px";
  });
}
window.addEventListener("resize", updatePoints);

// --- Charger points depuis Firebase ---
function loadPoints() {
  db.ref('points').on('value', snapshot => {
    mapContainer.querySelectorAll('.point').forEach(p => p.remove());
    const points = snapshot.val();
    if(points){
      Object.values(points).forEach(p => createPoint(p.x, p.y, p.type, p.content, p.enigme, p.code));
    }
  });
}

// --- Ajouter point Firebase ---
function savePointFirebase(xPercent, yPercent, type, content, enigme, code){
  const newRef = db.ref('points').push();
  newRef.set({x:xPercent, y:yPercent, type:type, content:content, enigme:enigme, code:code});
}

// --- Admin login ---
adminBtn.addEventListener("click", () => {
  if(!editMode){
    const id = prompt("Identifiant admin :");
    const pwd = prompt("Mot de passe :");
    if(id===ADMIN_ID && pwd===ADMIN_PWD){
      editMode = true;
      editHint.style.display = "block";
      adminBtn.textContent = "ðŸšª Quitter Ã©dition";
    } else alert("Mauvais identifiant ou mot de passe.");
  } else {
    editMode=false;
    editHint.style.display="none";
    adminBtn.textContent="ðŸ‘‘ Admin";
  }
});

// --- Ajouter point au clic ---
mapContainer.addEventListener("click", e => {
  if(!editMode) return;
  const rect = MapImage.getBoundingClientRect();
  const xPercent = ((e.clientX - rect.left)/rect.width)*100;
  const yPercent = ((e.clientY - rect.top)/rect.height)*100;

  const type = prompt("Type de contenu : image / lien / texte").toLowerCase();
  if(!["image","lien","texte"].includes(type)) return;

  const content = prompt("Entrez le contenu (URL ou texte)");
  const enigme = prompt("Entrez le texte de lâ€™Ã©nigme Ã  afficher :");
  const useCode = confirm("Voulez-vous un code secret pour dÃ©bloquer le contenu ?");
  const code = useCode ? prompt("Entrez le code secret :") : "";

  createPoint(xPercent,yPercent,type,content,enigme,code);
  savePointFirebase(xPercent,yPercent,type,content,enigme,code);
});

// --- Init ---
loadPoints();
</script>

</body>
</html>
